<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Body Progress Engine</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
            text-align: center;
        }

        .upload-section {
            background: #f5f5f5;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .upload-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #5568d3;
            background: #f9f9f9;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            padding: 15px;
        }

        .upload-label:hover {
            color: #667eea;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .compare-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .compare-btn:hover {
            background: #5568d3;
        }

        .compare-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-card.increase {
            border-left-color: #ff0000;
        }

        .stat-card.increase h3 {
            color: #ff0000;
        }

        .stat-card.decrease {
            border-left-color: #00ff00;
        }

        .stat-card.decrease h3 {
            color: #00ff00;
        }

        .visualization-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .visualization-container h2 {
            color: #333;
            margin-bottom: 20px;
        }

        #mesh-viewer {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #000;
        }

        .color-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        .legend-green {
            background: #00ff00;
        }

        .legend-red {
            background: #ff0000;
        }

        .legend-white {
            background: #ffffff;
            border: 2px solid #ddd;
        }

        .insights-panel {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 30px;
        }

        .insights-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .insights-panel p {
            line-height: 1.8;
            color: #333;
        }

        .region-breakdown {
            margin-top: 30px;
        }

        .region-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .region-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .region-stats {
            display: flex;
            gap: 20px;
        }

        .region-stat {
            flex: 1;
        }

        .region-stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .region-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .api-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ 3D Body Progress Engine</h1>
        <p class="subtitle">Visualize your body transformation over time with color-coded deformation analysis</p>

        <div class="upload-section">
            <h2>üì§ Upload 3D Mesh Files</h2>
            
            <div id="api-status" class="api-status disconnected">
                ‚ö†Ô∏è API not connected. Using demo mode.
            </div>

            <div class="file-upload">
                <div class="upload-box">
                    <label class="upload-label" for="baseline-file">
                        üìÅ Baseline Mesh<br/>
                        <small>(Week 0 - Initial scan)</small>
                    </label>
                    <input type="file" id="baseline-file" accept=".obj,.glb,.fbx">
                    <div class="file-name" id="baseline-name">No file selected</div>
                </div>

                <div class="upload-box">
                    <label class="upload-label" for="comparison-file">
                        üìÅ Comparison Mesh<br/>
                        <small>(Week 4, 8, 12... - Later scan)</small>
                    </label>
                    <input type="file" id="comparison-file" accept=".obj,.glb,.fbx">
                    <div class="file-name" id="comparison-name">No file selected</div>
                </div>
            </div>

            <button class="compare-btn" id="compare-btn" onclick="compareMeshes()" disabled>
                üîç Compare Meshes
            </button>
        </div>

        <div class="results-section" id="results-section">
            <div class="color-legend">
                <div class="legend-item">
                    <div class="legend-color legend-green"></div>
                    <span><strong>Green</strong> = Volume Reduction (Fat Loss)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-red"></div>
                    <span><strong>Red</strong> = Volume Increase (Muscle Gain)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-white"></div>
                    <span><strong>White</strong> = No Significant Change</span>
                </div>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated here -->
            </div>

            <div class="visualization-container">
                <h2>üé® 3D Visualization with Color Gradation</h2>
                <div id="mesh-viewer"></div>
            </div>

            <div class="region-breakdown" id="region-breakdown">
                <h2>üó∫Ô∏è Region Breakdown</h2>
                <!-- Region data will be populated here -->
            </div>

            <div class="insights-panel" id="insights-panel">
                <h2>üß† AI Insights</h2>
                <p id="insights-text">Loading insights...</p>
            </div>
        </div>
    </div>

    <script>
        let baselineFile = null;
        let comparisonFile = null;
        let scene, camera, renderer, mesh;
        const API_BASE = 'http://localhost:8000/api';

        // Check API connection
        async function checkAPI() {
            try {
                const response = await fetch(`${API_BASE.replace('/api', '')}/api/health`);
                if (response.ok) {
                    document.getElementById('api-status').className = 'api-status connected';
                    document.getElementById('api-status').textContent = '‚úì API Connected';
                    return true;
                }
            } catch (e) {
                console.log('API not available, using demo mode');
            }
            return false;
        }

        // File upload handlers
        document.getElementById('baseline-file').addEventListener('change', function(e) {
            baselineFile = e.target.files[0];
            document.getElementById('baseline-name').textContent = baselineFile ? baselineFile.name : 'No file selected';
            updateCompareButton();
        });

        document.getElementById('comparison-file').addEventListener('change', function(e) {
            comparisonFile = e.target.files[0];
            document.getElementById('comparison-name').textContent = comparisonFile ? comparisonFile.name : 'No file selected';
            updateCompareButton();
        });

        function updateCompareButton() {
            const btn = document.getElementById('compare-btn');
            btn.disabled = !(baselineFile && comparisonFile);
        }

        // Compare meshes
        async function compareMeshes() {
            const apiConnected = await checkAPI();
            
            if (apiConnected) {
                await compareViaAPI();
            } else {
                showDemoResults();
            }
        }

        // Compare via API
        async function compareViaAPI() {
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('compare-btn').disabled = true;
            document.getElementById('compare-btn').textContent = '‚è≥ Processing...';

            try {
                // Upload baseline
                const baselineFormData = new FormData();
                baselineFormData.append('file', baselineFile);
                baselineFormData.append('user_id', '1');

                const baselineResponse = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: baselineFormData
                });

                if (!baselineResponse.ok) throw new Error('Baseline upload failed');
                const baselineData = await baselineResponse.json();

                // Upload comparison
                const comparisonFormData = new FormData();
                comparisonFormData.append('file', comparisonFile);
                comparisonFormData.append('user_id', '1');

                const comparisonResponse = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: comparisonFormData
                });

                if (!comparisonResponse.ok) throw new Error('Comparison upload failed');
                const comparisonData = await comparisonResponse.json();

                // Get comparison
                const compareResponse = await fetch(`${API_BASE}/comparison/${baselineData.id}/${comparisonData.id}`);
                if (!compareResponse.ok) throw new Error('Comparison failed');
                const compareData = await compareResponse.json();

                // Get insights
                const insightsResponse = await fetch(`${API_BASE}/insights/${compareData.id}`);
                const insightsData = insightsResponse.ok ? await insightsResponse.json() : { text: 'Insights not available' };

                // Display results
                displayResults(compareData, insightsData);

            } catch (error) {
                document.getElementById('results-section').innerHTML = `
                    <div class="error">
                        <h3>Error</h3>
                        <p>${error.message}</p>
                        <p>Make sure the API server is running: <code>uvicorn app.main:app --reload</code></p>
                    </div>
                `;
            } finally {
                document.getElementById('compare-btn').disabled = false;
                document.getElementById('compare-btn').textContent = 'üîç Compare Meshes';
            }
        }

        // Show demo results
        function showDemoResults() {
            document.getElementById('results-section').style.display = 'block';
            
            const demoData = {
                statistics: {
                    avg_magnitude: 0.0234,
                    max_magnitude: 0.1456,
                    increase_percentage: 28.5,
                    decrease_percentage: 45.2
                },
                region_statistics: {
                    waist: {
                        increase_percentage: 15.2,
                        decrease_percentage: 65.8,
                        avg_magnitude: 0.0345
                    },
                    chest: {
                        increase_percentage: 42.3,
                        decrease_percentage: 12.1,
                        avg_magnitude: 0.0289
                    },
                    arms: {
                        increase_percentage: 38.5,
                        decrease_percentage: 8.2,
                        avg_magnitude: 0.0212
                    },
                    thighs: {
                        increase_percentage: 18.5,
                        decrease_percentage: 52.3,
                        avg_magnitude: 0.0312
                    }
                },
                color_data: {
                    vertices: [],
                    colors: []
                }
            };

            const demoInsights = {
                text: "Overall body volume shows significant reduction, with 45.2% of vertices showing decrease. Waist region reduced ~66%, most change in lower abdomen. Upper arms and chest show moderate volume increase, likely muscle gain. This indicates successful body recomposition with fat loss and muscle gain. Note: This is a visual estimation based on 3D mesh comparison, not a medical diagnosis."
            };

            displayResults(demoData, demoInsights);
            createDemoVisualization();
        }

        // Display results
        function displayResults(data, insights) {
            // Statistics
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Average Change</h3>
                    <div class="value">${data.statistics.avg_magnitude.toFixed(4)}</div>
                </div>
                <div class="stat-card">
                    <h3>Max Change</h3>
                    <div class="value">${data.statistics.max_magnitude.toFixed(4)}</div>
                </div>
                <div class="stat-card increase">
                    <h3>Increase</h3>
                    <div class="value">${data.statistics.increase_percentage.toFixed(1)}%</div>
                </div>
                <div class="stat-card decrease">
                    <h3>Decrease</h3>
                    <div class="value">${data.statistics.decrease_percentage.toFixed(1)}%</div>
                </div>
            `;

            // Region breakdown
            const regionBreakdown = document.getElementById('region-breakdown');
            let regionHTML = '<h2>üó∫Ô∏è Region Breakdown</h2>';
            for (const [region, stats] of Object.entries(data.region_statistics)) {
                regionHTML += `
                    <div class="region-item">
                        <h3>${region.replace('_', ' ').toUpperCase()}</h3>
                        <div class="region-stats">
                            <div class="region-stat">
                                <div class="region-stat-label">Increase</div>
                                <div class="region-stat-value" style="color: #ff0000;">${stats.increase_percentage.toFixed(1)}%</div>
                            </div>
                            <div class="region-stat">
                                <div class="region-stat-label">Decrease</div>
                                <div class="region-stat-value" style="color: #00aa00;">${stats.decrease_percentage.toFixed(1)}%</div>
                            </div>
                            <div class="region-stat">
                                <div class="region-stat-label">Avg Magnitude</div>
                                <div class="region-stat-value">${stats.avg_magnitude.toFixed(4)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            regionBreakdown.innerHTML = regionHTML;

            // Insights
            document.getElementById('insights-text').textContent = insights.text;

            // Create visualization if we have color data
            if (data.color_data && data.color_data.vertices && data.color_data.vertices.length > 0) {
                createVisualization(data.color_data);
            } else {
                createDemoVisualization();
            }
        }

        // Create 3D visualization
        function createVisualization(colorData) {
            const container = document.getElementById('mesh-viewer');
            container.innerHTML = '';

            const vertices = colorData.vertices;
            const colors = colorData.colors;

            // Create Three.js scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);

            // Create geometry
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(vertices.flat());
            const colorArray = new Float32Array(colors.flat().map(c => c / 255));

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));

            // Create material
            const material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true
            });

            mesh = new THREE.Points(geometry, material);
            scene.add(mesh);

            // Add lights
            const light1 = new THREE.DirectionalLight(0xffffff, 1);
            light1.position.set(1, 1, 1);
            scene.add(light1);

            const light2 = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(light2);

            // Position camera
            camera.position.z = 3;

            // Controls
            let mouseX = 0, mouseY = 0;
            let targetRotationX = 0, targetRotationY = 0;

            container.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / container.offsetWidth) * 2 - 1;
                mouseY = (e.clientY / container.offsetHeight) * 2 - 1;
                targetRotationY = mouseX * Math.PI;
                targetRotationX = mouseY * Math.PI;
            });

            // Animation
            function animate() {
                requestAnimationFrame(animate);
                mesh.rotation.y += (targetRotationY - mesh.rotation.y) * 0.05;
                mesh.rotation.x += (targetRotationX - mesh.rotation.x) * 0.05;
                renderer.render(scene, camera);
            }
            animate();
        }

        // Create demo visualization
        function createDemoVisualization() {
            const container = document.getElementById('mesh-viewer');
            
            // Create a demo 3D plot using Plotly
            const demoData = {
                x: [],
                y: [],
                z: [],
                mode: 'markers',
                type: 'scatter3d',
                marker: {
                    size: 3,
                    color: [],
                    colorscale: [[0, 'rgb(0,255,0)'], [0.5, 'rgb(255,255,255)'], [1, 'rgb(255,0,0)']],
                    showscale: true,
                    colorbar: { title: 'Change' }
                }
            };

            // Generate demo points
            for (let i = 0; i < 500; i++) {
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                const r = 1 + Math.random() * 0.3;
                
                demoData.x.push(r * Math.sin(phi) * Math.cos(theta));
                demoData.y.push(r * Math.cos(phi));
                demoData.z.push(r * Math.sin(phi) * Math.sin(theta));
                
                // Random color for demo
                demoData.marker.color.push(Math.random());
            }

            const layout = {
                title: '3D Body Mesh with Color Gradation (Demo)',
                scene: {
                    xaxis: { title: 'Width' },
                    yaxis: { title: 'Height' },
                    zaxis: { title: 'Depth' },
                    aspectmode: 'data'
                },
                height: 600
            };

            Plotly.newPlot(container, [demoData], layout);
        }

        // Check API on load
        checkAPI();
    </script>
</body>
</html>
